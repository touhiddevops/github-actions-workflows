name: Image Build and Push to ECR
on:
  push:
    branches:
      - develop
  workflow_dispatch:

env:
  AWS_REGION_ECS: us-east-2
  ECR_REPOSITORY: ageticredit-frontend
  ECS_CLUSTER: rc-ecs-cluster-dev
  SERVICE_NAME: ageticredit-frontend-dev
  CONTAINER_NAME: ageticredit-frontend-dev

permissions:
  contents: read
  id-token: write   # REQUIRED for OIDC
  issues: write

jobs:
  build-and-push:
    name: Build and Push Image
    runs-on: ubuntu-latest
    outputs:
      image_uri: ${{ steps.image-uri.outputs.image_uri }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # OIDC: assume the IAM role (no static keys)
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::756739382182:role/rc-gha-ecr-push
          aws-region: ${{ env.AWS_REGION_ECS }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # (Optional) Ensure ECR repository exists â€” safe if it already exists
      - name: Ensure ECR repository exists
        run: |
          aws ecr describe-repositories --repository-names "${{ env.ECR_REPOSITORY }}" --region "${{ env.AWS_REGION_ECS }}" >/dev/null 2>&1 || \
          aws ecr create-repository --repository-name "${{ env.ECR_REPOSITORY }}" --region "${{ env.AWS_REGION_ECS }}"

      - name: Set Image URI variable
        id: image-uri
        run: |
          REGISTRY="${{ steps.login-ecr.outputs.registry }}"
          IMAGE_URI="${REGISTRY}/${{ env.ECR_REPOSITORY }}:latest"
          echo "image_uri=${IMAGE_URI}" >> "$GITHUB_OUTPUT"
          echo "IMAGE_URI=${IMAGE_URI}" >> "$GITHUB_ENV"
          # extra tags (recommended)
          echo "IMAGE_SHA=${REGISTRY}/${{ env.ECR_REPOSITORY }}:${GITHUB_SHA::12}" >> "$GITHUB_ENV"

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_URI }}
            ${{ env.IMAGE_SHA }}
          cache-from: type=gha
          cache-to: type=gha,mode=max