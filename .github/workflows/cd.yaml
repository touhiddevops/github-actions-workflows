name: CD Pipeline - Deploy to EC2

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: false
        default: 'dev_server'
  push:
    branches: [ dev_server ]

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    environment:
      name: development_server
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: dev_server

      - name: Set up SSH
        env:
          KEY_RAW: ${{ secrets.EC2_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "$KEY_RAW" > ~/.ssh/id_ed25519
          sed -i 's/\r$//' ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keygen -y -f ~/.ssh/id_ed25519 >/dev/null 2>&1 || { echo "::error::Invalid private key"; exit 1; }
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts

      - name: Ensure remote directory exists
        run: |
          ssh -o IdentitiesOnly=yes -o StrictHostKeyChecking=yes -i ~/.ssh/id_ed25519 \
            "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}" \
            "mkdir -p '${{ secrets.DEPLOY_DIR }}'"

      - name: Rsync code to EC2
        continue-on-error: false
        run: |
          rsync -avz \
            --exclude ".git/" \
            --exclude "node_modules/" \
            --exclude ".next/" \
            --exclude "*.log" \
            --exclude ".env" \
            --exclude ".env.local" \
            --exclude ".env.*.local" \
            --exclude "npm-debug.log*" \
            --exclude "yarn-debug.log*" \
            --exclude "yarn-error.log*" \
            -e "ssh -i ~/.ssh/id_ed25519 -o IdentitiesOnly=yes -o StrictHostKeyChecking=yes" \
            ./ "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${{ secrets.DEPLOY_DIR }}/"

      - name: Deploy with Docker Compose
        continue-on-error: false
        run: |
          ssh -o IdentitiesOnly=yes -o StrictHostKeyChecking=yes -i ~/.ssh/id_ed25519 \
            "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}" \
            "set -e; \
             cd '${{ secrets.DEPLOY_DIR }}'; \
             docker compose --profile dev down || true; \
             docker compose --profile dev build --no-cache; \
             docker compose --profile dev up -d --build; \
             docker compose --profile dev ps; \
             docker compose --profile dev logs --tail=50"

      - name: Health check
        continue-on-error: true
        run: |
          sleep 10
          ssh -o IdentitiesOnly=yes -o StrictHostKeyChecking=yes -i ~/.ssh/id_ed25519 \
            "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}" \
            "cd '${{ secrets.DEPLOY_DIR }}'; docker compose --profile dev ps"

      - name: Deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment successful"
          else
            echo "❌ Deployment failed"
            exit 1
          fi
